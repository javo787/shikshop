import { connectMongoDB } from '@/lib/mongodb';
import Product from '@/models/Product'; // ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤

export default async function sitemap() {
  // 1. –í–∞—à –¥–æ–º–µ–Ω
  const baseUrl = 'https://shikshop.vercel.app';

  // 2. –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ì–ª–∞–≤–Ω–∞—è, –ö–∞—Ç–∞–ª–æ–≥, –û –Ω–∞—Å)
  const routes = [
    '',
    '/catalog',
    // '/about', // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    // '/contacts',
  ].map((route) => ({
    url: `${baseUrl}${route}`,
    lastModified: new Date(),
    changeFrequency: 'daily', // –ì–ª–∞–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç–æ
    priority: 1,              // –°–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
  }));

  // 3. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¢–û–í–ê–†–û–í (–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å)
  let productUrls = [];
  
  try {
    await connectMongoDB();
    
    // –ü–æ–ª—É—á–∞–µ–º ID –∏ –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
    // lean() –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –±—ã—Å—Ç—Ä–µ–µ
    const products = await Product.find({}, '_id updatedAt').lean();

    productUrls = products.map((product) => ({
      // üëá –í–ù–ò–ú–ê–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫ —É –≤–∞—Å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–≤–∞—Ä. 
      // –ï—Å–ª–∏ /product/123, –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–∞–∫. –ï—Å–ª–∏ /catalog/123, –ø–æ–º–µ–Ω—è–π—Ç–µ.
      url: `${baseUrl}/product/${product._id}`, 
      lastModified: product.updatedAt || new Date(),
      changeFrequency: 'weekly', // –¢–æ–≤–∞—Ä –º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–∂–µ
      priority: 0.8,             // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –Ω–æ –Ω–∏–∂–µ –≥–ª–∞–≤–Ω–æ–π
    }));
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ sitemap –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤:', error);
    // –ï—Å–ª–∏ –±–∞–∑–∞ —É–ø–∞–ª–∞, —Å–∞–π—Ç–º–∞—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–¥–∞—Å—Ç —Ö–æ—Ç—è –±—ã –≥–ª–∞–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  }

  // 4. –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ –æ—Ç–¥–∞–µ–º
  return [...routes, ...productUrls];
}